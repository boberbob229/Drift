<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>drift — admin panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=Fraunces:opsz,wght@9..144,300;9..144,400;9..144,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
          max-width: 1100px;
          margin: 0 auto;
          padding: 48px 32px;
        }

        .admin-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 48px;
          padding-bottom: 28px;
          border-bottom: 1px solid var(--border);
        }

        .admin-title {
          font-family: 'Fraunces', serif;
          font-size: 28px;
          font-weight: 400;
          display: flex;
          align-items: center;
          gap: 14px;
        }

        .admin-title a {
          color: inherit;
          text-decoration: none;
        }

        .admin-badge {
          font-family: 'DM Sans', sans-serif;
          font-size: 11px;
          padding: 6px 14px;
          background: linear-gradient(135deg, var(--accent-soft) 0%, color-mix(in srgb, var(--accent-soft) 50%, var(--bg-subtle)) 100%);
          color: var(--accent);
          border-radius: 100px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.06em;
          border: 1px solid color-mix(in srgb, var(--accent) 20%, transparent);
        }

        .admin-tabs {
          display: flex;
          gap: 10px;
          margin-bottom: 36px;
          flex-wrap: wrap;
        }

        .admin-tab {
          font-family: inherit;
          font-size: 14px;
          padding: 12px 24px;
          background: var(--bg-subtle);
          border: 1px solid var(--border);
          border-radius: 100px;
          cursor: pointer;
          color: var(--text-soft);
          transition: all 0.2s ease;
          font-weight: 500;
        }

        .admin-tab:hover {
          color: var(--text);
          border-color: var(--text-muted);
        }

        .admin-tab.active {
          background: var(--text);
          color: var(--bg);
          border-color: var(--text);
        }

        .admin-panel { display: none; animation: fadeUp 0.4s ease; }
        .admin-panel.active { display: block; }

        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 18px;
          margin-bottom: 44px;
        }

        .stat-card {
          background: var(--bg-elevated);
          border: 1px solid var(--border);
          border-radius: 18px;
          padding: 28px;
          transition: all 0.2s ease;
        }

        .stat-card:hover {
          transform: translateY(-3px);
          box-shadow: 0 12px 32px rgba(0,0,0,0.08);
        }

        .stat-card-value {
          font-family: 'Fraunces', serif;
          font-size: 40px;
          font-weight: 400;
          color: var(--text);
          margin-bottom: 6px;
          letter-spacing: -0.02em;
        }

        .stat-card-label {
          font-size: 13px;
          color: var(--text-muted);
          font-weight: 500;
        }

        .data-table {
          width: 100%;
          border-collapse: collapse;
          background: var(--bg-elevated);
          border-radius: 18px;
          overflow: hidden;
          border: 1px solid var(--border);
        }

        .data-table th {
          text-align: left;
          padding: 18px 22px;
          font-size: 11px;
          font-weight: 600;
          color: var(--text-muted);
          text-transform: uppercase;
          letter-spacing: 0.06em;
          background: var(--bg-subtle);
          border-bottom: 1px solid var(--border);
        }

        .data-table td {
          padding: 18px 22px;
          font-size: 14px;
          color: var(--text);
          border-bottom: 1px solid var(--border);
        }

        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: var(--bg-subtle); }

        .user-cell {
          display: flex;
          align-items: center;
          gap: 14px;
        }

        .user-avatar {
          width: 36px;
          height: 36px;
          border-radius: 50%;
          background: var(--bg-subtle);
          border: 1px solid var(--border);
          display: grid;
          place-items: center;
          font-size: 13px;
          font-weight: 600;
          color: var(--text-soft);
          overflow: hidden;
        }

        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .status-badge {
          font-size: 11px;
          padding: 5px 12px;
          border-radius: 100px;
          font-weight: 600;
        }

        .status-active {
          background: var(--success-soft);
          color: var(--success);
        }

        .status-used {
          background: var(--bg-subtle);
          color: var(--text-muted);
        }

        .action-btn {
          font-family: inherit;
          font-size: 12px;
          padding: 8px 14px;
          background: transparent;
          border: 1px solid var(--border);
          border-radius: 8px;
          cursor: pointer;
          color: var(--text-soft);
          transition: all 0.15s ease;
          font-weight: 500;
        }

        .action-btn:hover {
          background: var(--bg-subtle);
          color: var(--text);
        }

        .action-btn.danger {
          border-color: var(--error);
          color: var(--error);
        }

        .action-btn.danger:hover {
          background: rgba(196, 122, 122, 0.1);
        }

        .toolbar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 28px;
          gap: 16px;
        }

        .search-input {
          flex: 1;
          max-width: 400px;
          padding: 14px 20px;
          background: var(--bg-subtle);
          border: 1px solid var(--border);
          border-radius: 14px;
          font-family: inherit;
          font-size: 14px;
          color: var(--text);
          transition: all 0.2s ease;
        }

        .search-input:focus {
          outline: none;
          border-color: var(--accent);
          box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .search-input::placeholder { color: var(--text-muted); }

        .section-title {
          font-family: 'Fraunces', serif;
          font-size: 20px;
          font-weight: 400;
          margin-bottom: 24px;
        }

        .empty-state {
          text-align: center;
          padding: 72px 24px;
          color: var(--text-muted);
        }

        @media (max-width: 768px) {
          .admin-container { padding: 24px 20px; }
          .admin-header { flex-direction: column; gap: 20px; align-items: flex-start; }
          .admin-tabs { flex-wrap: wrap; }
          .stats-grid { grid-template-columns: repeat(2, 1fr); }
          .data-table { display: block; overflow-x: auto; }
          .toolbar { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
<div class="admin-container">
    <header class="admin-header">
        <h1 class="admin-title">
            <a href="index.html">drift</a>
            <span class="admin-badge">admin</span>
        </h1>
        <div class="header-right">
            <button class="theme-btn" onclick="toggleTheme()" aria-label="Toggle theme">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="4"/>
                    <path d="M12 2v2m0 16v2M4 12H2m20 0h-2m-2.93-7.07 1.41-1.41M5.52 18.48l1.41-1.41m11.55 0 1.41 1.41M5.52 5.52 6.93 6.93"/>
                </svg>
            </button>
            <button class="action-btn" onclick="logout()">Logout</button>
        </div>
    </header>

    <nav class="admin-tabs">
        <button class="admin-tab active" data-panel="overview">Overview</button>
        <button class="admin-tab" data-panel="users">Users</button>
        <button class="admin-tab" data-panel="sessions">Sessions</button>
        <button class="admin-tab" data-panel="invites">Invites</button>
    </nav>

    <div class="admin-panel active" id="overview">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-value" id="totalUsers">0</div>
                <div class="stat-card-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value" id="totalSessions">0</div>
                <div class="stat-card-label">Total Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value" id="totalHours">0h</div>
                <div class="stat-card-label">Hours Studied</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value" id="activeToday">0</div>
                <div class="stat-card-label">Active Today</div>
            </div>
        </div>

        <h3 class="section-title">Recent Activity</h3>
        <table class="data-table">
            <thead>
            <tr>
                <th>User</th>
                <th>Activity</th>
                <th>Time</th>
            </tr>
            </thead>
            <tbody id="recentActivity">
            <tr><td colspan="3" class="empty-state">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="admin-panel" id="users">
        <div class="toolbar">
            <input type="text" class="search-input" placeholder="Search users..." id="userSearch" oninput="searchUsers()">
            <button class="btn btn-primary" onclick="openCreateUser()">+ Add User</button>
        </div>

        <table class="data-table">
            <thead>
            <tr>
                <th>User</th>
                <th>Sessions</th>
                <th>Total Time</th>
                <th>Streak</th>
                <th>Joined</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="usersTable">
            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="admin-panel" id="sessions">
        <div class="toolbar">
            <input type="text" class="search-input" placeholder="Filter by user or label..." id="sessionSearch" oninput="searchSessions()">
        </div>

        <table class="data-table">
            <thead>
            <tr>
                <th>User</th>
                <th>Label</th>
                <th>Duration</th>
                <th>Date</th>
                <th>Time</th>
            </tr>
            </thead>
            <tbody id="sessionsTable">
            <tr><td colspan="5" class="empty-state">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="admin-panel" id="invites">
        <div class="toolbar">
            <input type="text" class="search-input" placeholder="Search invites..." id="inviteSearch" oninput="searchInvites()">
            <button class="btn btn-primary" onclick="generateAdminInvite()">+ Generate Invite</button>
        </div>

        <table class="data-table">
            <thead>
            <tr>
                <th>Code</th>
                <th>Created By</th>
                <th>Status</th>
                <th>Used By</th>
                <th>Created</th>
            </tr>
            </thead>
            <tbody id="invitesTable">
            <tr><td colspan="5" class="empty-state">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal-bg" id="createUserModal">
    <div class="modal">
        <div class="modal-head">
            <h3 class="modal-title">Create User</h3>
            <button class="modal-close" onclick="closeModal('createUserModal')" aria-label="Close">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>
            </button>
        </div>
        <form id="createUserForm" style="display: flex; flex-direction: column; gap: 14px;">
            <input type="text" class="form-input" id="newUsername" placeholder="Username" style="padding: 14px 18px; background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 12px; font-family: inherit; font-size: 14px; color: var(--text);" required>
            <input type="password" class="form-input" id="newPassword" placeholder="Password" style="padding: 14px 18px; background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 12px; font-family: inherit; font-size: 14px; color: var(--text);" required>
            <button type="submit" class="btn btn-primary" style="margin-top: 8px;">Create User</button>
        </form>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    const theme = localStorage.getItem('drift_theme') || 'dark';
    document.documentElement.dataset.theme = theme;

    function toggleTheme() {
      const next = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
      document.documentElement.dataset.theme = next;
      localStorage.setItem('drift_theme', next);
    }

    function toast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2800);
    }

    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    function openCreateUser() { document.getElementById('createUserModal').classList.add('open'); }

    document.querySelectorAll('.modal-bg').forEach(m => {
      m.onclick = e => { if (e.target === m) m.classList.remove('open'); };
    });

    document.querySelectorAll('.admin-tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.panel).classList.add('active');
      };
    });

    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = 'index.html';
    }

    let allUsers = [];
    let allSessions = [];
    let allInvites = [];

    function fmtMin(m) {
      if (m === 0) return '0m';
      if (m >= 60) {
        const h = Math.floor(m / 60);
        const min = m % 60;
        return min > 0 ? `${h}h ${min}m` : `${h}h`;
      }
      return `${m}m`;
    }

    function fmtDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    async function init() {
      try {
        const res = await fetch('/api/me');
        if (!res.ok) throw new Error();
        const user = await res.json();
        if (user.username !== 'admin') { window.location.href = 'app.html'; return; }
        await loadData();
      } catch (e) { window.location.href = 'index.html'; }
    }

    async function loadData() {
      try {
        const [usersRes, sessionsRes, invitesRes] = await Promise.all([
          fetch('/api/admin/users'),
          fetch('/api/admin/sessions'),
          fetch('/api/admin/invites')
        ]);

        allUsers = await usersRes.json();
        allSessions = await sessionsRes.json();
        allInvites = await invitesRes.json();

        renderOverview();
        renderUsers();
        renderSessions();
        renderInvites();
      } catch (e) {
        console.error('Failed to load admin data:', e);
        loadMockData();
      }
    }

    function loadMockData() {
      allUsers = [
        { id: 1, username: 'admin', avatar: null, sessions: 45, totalMinutes: 2340, streak: 12, created_at: '2024-01-15' },
        { id: 2, username: 'alice', avatar: null, sessions: 28, totalMinutes: 1680, streak: 8, created_at: '2024-02-20' },
        { id: 3, username: 'bob', avatar: null, sessions: 15, totalMinutes: 890, streak: 3, created_at: '2024-03-10' },
      ];

      allSessions = [
        { id: 1, username: 'alice', label: 'focus', color: 'var(--text-soft)', minutes: 45, date: '2024-03-15', time: '14:30' },
        { id: 2, username: 'bob', label: 'math', color: '#c4937a', minutes: 60, date: '2024-03-15', time: '10:00' },
        { id: 3, username: 'admin', label: 'coding', color: '#7a8a9b', minutes: 90, date: '2024-03-14', time: '09:15' },
      ];

      allInvites = [
        { code: 'DRIFT-A1B2C3D4', created_by: 'admin', used_by: 'alice', created_at: '2024-01-20' },
        { code: 'DRIFT-E5F6G7H8', created_by: 'admin', used_by: 'bob', created_at: '2024-02-15' },
        { code: 'DRIFT-I9J0K1L2', created_by: 'alice', used_by: null, created_at: '2024-03-10' },
      ];

      renderOverview();
      renderUsers();
      renderSessions();
      renderInvites();
    }

    function renderOverview() {
      document.getElementById('totalUsers').textContent = allUsers.length;
      document.getElementById('totalSessions').textContent = allSessions.length;

      const totalMinutes = allUsers.reduce((sum, u) => sum + (u.totalMinutes || 0), 0);
      document.getElementById('totalHours').textContent = Math.floor(totalMinutes / 60) + 'h';

      const today = new Date().toISOString().split('T')[0];
      const activeToday = allSessions.filter(s => s.date === today).length;
      document.getElementById('activeToday').textContent = activeToday;

      const recentSessions = allSessions.slice(0, 10);
      document.getElementById('recentActivity').innerHTML = recentSessions.map(s => `
        <tr>
          <td>
            <div class="user-cell">
              <div class="user-avatar">${s.username[0].toUpperCase()}</div>
              <span>${s.username}</span>
            </div>
          </td>
          <td><span style="color: ${s.color}">●</span> ${s.label} — ${fmtMin(s.minutes)}</td>
          <td style="color: var(--text-muted)">${s.date} at ${s.time}</td>
        </tr>
      `).join('') || '<tr><td colspan="3" class="empty-state">No recent activity</td></tr>';
    }

    function renderUsers(filter = '') {
      const filtered = allUsers.filter(u => u.username.toLowerCase().includes(filter.toLowerCase()));
      document.getElementById('usersTable').innerHTML = filtered.map(u => `
        <tr>
          <td>
            <div class="user-cell">
              <div class="user-avatar">${u.avatar ? `<img src="/uploads/${u.avatar}">` : u.username[0].toUpperCase()}</div>
              <span>${u.username}</span>
            </div>
          </td>
          <td>${u.sessions || 0}</td>
          <td>${fmtMin(u.totalMinutes || 0)}</td>
          <td>${u.streak || 0} days</td>
          <td style="color: var(--text-muted)">${fmtDate(u.created_at)}</td>
          <td>
            ${u.username !== 'admin' ? `<button class="action-btn danger" onclick="deleteUser(${u.id})">Delete</button>` : '—'}
          </td>
        </tr>
      `).join('') || '<tr><td colspan="6" class="empty-state">No users found</td></tr>';
    }

    function renderSessions(filter = '') {
      const filtered = allSessions.filter(s =>
        s.username.toLowerCase().includes(filter.toLowerCase()) ||
        s.label.toLowerCase().includes(filter.toLowerCase())
      );
      document.getElementById('sessionsTable').innerHTML = filtered.map(s => `
        <tr>
          <td>
            <div class="user-cell">
              <div class="user-avatar">${s.username[0].toUpperCase()}</div>
              <span>${s.username}</span>
            </div>
          </td>
          <td><span style="color: ${s.color}">●</span> ${s.label}</td>
          <td>${fmtMin(s.minutes)}</td>
          <td>${s.date}</td>
          <td style="color: var(--text-muted)">${s.time}</td>
        </tr>
      `).join('') || '<tr><td colspan="5" class="empty-state">No sessions found</td></tr>';
    }

    function renderInvites(filter = '') {
      const filtered = allInvites.filter(i =>
        i.code.toLowerCase().includes(filter.toLowerCase()) ||
        i.created_by.toLowerCase().includes(filter.toLowerCase())
      );
      document.getElementById('invitesTable').innerHTML = filtered.map(i => `
        <tr>
          <td style="font-family: monospace; letter-spacing: 0.05em;">${i.code}</td>
          <td>${i.created_by}</td>
          <td><span class="status-badge ${i.used_by ? 'status-used' : 'status-active'}">${i.used_by ? 'Used' : 'Available'}</span></td>
          <td>${i.used_by || '—'}</td>
          <td style="color: var(--text-muted)">${fmtDate(i.created_at)}</td>
        </tr>
      `).join('') || '<tr><td colspan="5" class="empty-state">No invites found</td></tr>';
    }

    function searchUsers() { renderUsers(document.getElementById('userSearch').value); }
    function searchSessions() { renderSessions(document.getElementById('sessionSearch').value); }
    function searchInvites() { renderInvites(document.getElementById('inviteSearch').value); }

    async function deleteUser(id) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      try {
        const res = await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
        if (res.ok) {
          toast('User deleted');
          allUsers = allUsers.filter(u => u.id !== id);
          renderUsers();
          renderOverview();
        } else {
          const data = await res.json();
          toast(data.error || 'Failed to delete user');
        }
      } catch (e) { toast('Failed to delete user'); }
    }

    async function generateAdminInvite() {
      try {
        const res = await fetch('/api/generate-invite', { method: 'POST' });
        const data = await res.json();
        if (data.code) {
          await navigator.clipboard.writeText(data.code);
          toast(`${data.code} copied!`);
          allInvites.unshift({ code: data.code, created_by: 'admin', used_by: null, created_at: new Date().toISOString() });
          renderInvites();
        }
      } catch (e) { toast('Failed to generate invite'); }
    }

    document.getElementById('createUserForm').onsubmit = async (e) => {
      e.preventDefault();
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value;

      if (username.length < 3) { toast('Username must be at least 3 characters'); return; }
      if (password.length < 8) { toast('Password must be at least 8 characters'); return; }

      try {
        const res = await fetch('/api/admin/create-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (data.success) {
          toast('User created');
          closeModal('createUserModal');
          document.getElementById('newUsername').value = '';
          document.getElementById('newPassword').value = '';
          await loadData();
        } else {
          toast(data.error || 'Failed to create user');
        }
      } catch (e) { toast('Failed to create user'); }
    };

    init();
</script>
</body>
</html>